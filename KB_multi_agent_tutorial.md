# Multi-Agent 协同机制科普：JSON State 与 System Notice

对于初次接触 Multi-Agent（多智能体）开发的开发者来说，理解 Agent 之间如何“沟通”和“共享记忆”是最大的难点。在我们的架构中，这种沟通主要通过 **JSON State** 和 **System Notice** 两个核心概念来实现。

这就好比我们在进行一场**外科手术**：
*   **前台 Agent (主刀医生)**：专注于手头的操作（与用户对话），不能分心。
*   **后台 Agent (麻醉师/监测员)**：盯着仪器（数据），随时告诉主刀医生病人的生命体征。

---

## 1. 什么是 JSON State (共享记忆库)？

**JSON State** 就是两个 Agent 共同维护的“病历本”或“记分牌”。它是整个系统的**单一事实来源 (Single Source of Truth)**。

### 通俗解释
想象你正在和一个客户聊天，你的脑海里会逐渐形成一个对这个客户的认知模型：
*   他叫什么？(Name)
*   他是干嘛的？(Job)
*   他想要什么？(Needs)

这个认知模型在计算机里，就是一段 JSON 数据。

### 示例
```json
// 这就是 JSON State
{
  "user_profile": {
    "nickname": "张三",
    "role": "独立开发者",  // <-- 后台 Agent 从对话中分析出来的
    "skill": "Python"
  },
  "status": "In-Progress"
}
```

### 为什么重要？
1.  **持久化：** 它是存盘点。即使对话断了，只要有这个 JSON，下一个接手的 Agent 也能瞬间知道聊到哪了。
2.  **解耦：** 前台 Agent 不需要记住所有细节，它只需要在需要的时候去查一下这个 JSON。

---

## 2. 什么是 System Notice (耳麦里的提示音)？

**System Notice** 是后台 Agent 传给前台 Agent 的“悄悄话”或“小纸条”。它是一种**动态指令**。

### 通俗解释
在手术中，监测员（后台 Agent）看到血压下降了，他不会直接去抢主刀医生（前台 Agent）的手术刀，而是通过耳麦说一句：
> “医生，病人血压偏低，请注意止血。”

这句话就是 **System Notice**。

### 它是如何工作的？
1.  **后台分析：** 后台 Agent 盯着 JSON State，发现 `pain_intensity`（痛点强度）字段是空的。
2.  **生成提示：** 后台 Agent 生成一段文字：“还没问痛点呢，快问问他到底哪里疼。”
3.  **注入前台：** 在下一轮用户说话之前，系统把这段文字**插入**到前台 Agent 的 prompt 里（通常放在 `system` 消息的末尾）。

### 示例 (前台 Agent 看到的 Prompt)
```text
[System]
你是一名社会研究员...（此处省略 1000 字基础指令）...

[System Notice] (来自后台的最新提示)
⚠️ 警告：用户刚才提到了“想做个App”，但我们还不知道他会不会写代码。
👉 建议：下一句请委婉询问他的技术背景，以便评估可行性。
```

---

## 3. 它们如何配合？(协同循环)

让我们看一个完整的**闭环**：

1.  **用户说：** “我每天处理发票好累啊。”
2.  **前台回：** “是吗？具体是哪个环节最累？”（前台只管顺着话说）
    *   *此时，前台并不知道这代表了什么数据含义。*
3.  **后台听到了：** 后台 Agent 分析对话，心想：“哦！这是痛点！而且涉及发票处理。”
4.  **后台更新 JSON State：**
    ```json
    "pain_hooks": [{ "description": "发票处理繁琐", "intensity": 7 }]
    ```
5.  **后台生成 System Notice：**
    > “已记录痛点。下一步请确认他是用什么软件处理发票的，看看有没有 API 接口。”
6.  **下一轮：** 前台 Agent 收到这个 Notice，于是问道：“那你现在是用 Excel 还是什么专门的财务软件来弄呢？”

**总结：**
*   **JSON State** 是**静态的快照**（现在的状态是什么）。
*   **System Notice** 是**动态的指令**（接下来该干什么）。
*   两者配合，实现了“脑”（后台）指挥“手”（前台）。
